<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automotive Predictive Maintenance AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Minimal Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-car text-xl text-blue-600"></i>
                <h1 class="text-xl font-semibold text-gray-900">Predictive Maintenance AI</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <span class="status-dot bg-green-500"></span>
                    <span>Operational</span>
                </div>
                <button onclick="refreshDashboard()" class="text-gray-600 hover:text-gray-900 p-2">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-6">
        <!-- Stats Row -->
        <div class="grid grid-cols-4 gap-4 mb-6" id="stats-container"></div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Main Column -->
            <div class="col-span-2 space-y-6">
                <!-- Vehicle Monitoring -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Vehicle Monitoring</h2>
                        <select id="vehicle-select" class="text-sm border border-gray-300 rounded px-3 py-1.5" onchange="loadVehicleData()">
                            <option value="">Select Vehicle</option>
                        </select>
                    </div>
                    
                    <div id="vehicle-details" class="mb-4"></div>
                    <div id="telematics-grid" class="grid grid-cols-4 gap-3 mb-4"></div>
                    <div id="health-score-container"></div>
                </div>

                <!-- Failure Predictions -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Failure Predictions</h2>
                    <div id="predictions-container"></div>
                </div>

                <!-- RCA/CAPA Insights -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">RCA/CAPA Insights</h2>
                    <div id="rca-container"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- AI Agent Status -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">AI Agents</h2>
                    <div id="agents-container" class="space-y-2"></div>
                </div>

                <!-- Service Demand -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Service Demand</h2>
                    <canvas id="demand-chart"></canvas>
                </div>

                <!-- UEBA Security -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Security Monitoring</h2>
                    <div id="ueba-container"></div>
                </div>

                <!-- Demo Controls -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Demo Controls</h2>
                    <div class="space-y-2">
                        <button onclick="simulateCriticalIssue()" class="w-full bg-red-600 text-white text-sm px-4 py-2 rounded hover:bg-red-700">
                            Simulate Critical Issue
                        </button>
                        <button onclick="runOrchestrationDemo()" class="w-full bg-blue-600 text-white text-sm px-4 py-2 rounded hover:bg-blue-700">
                            Run Orchestration Demo
                        </button>
                        <button onclick="showRCAInsights()" class="w-full bg-yellow-600 text-white text-sm px-4 py-2 rounded hover:bg-yellow-700">
                            Show RCA Insights
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentVehicle = null;
        let demandChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadVehicles();
            loadAgents();
            loadServiceDemand();
            
            setTimeout(() => {
                const select = document.getElementById('vehicle-select');
                if (select.options.length > 1) {
                    select.value = select.options[1].value;
                    loadVehicleData();
                }
            }, 500);
        });

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const stats = await response.json();
                
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-50 rounded flex items-center justify-center">
                                <i class="fas fa-car text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Total Vehicles</p>
                                <p class="text-2xl font-semibold">${stats.total_vehicles}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-red-50 rounded flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">With Issues</p>
                                <p class="text-2xl font-semibold">${stats.vehicles_with_issues}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-50 rounded flex items-center justify-center">
                                <i class="fas fa-heart-pulse text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Avg Health</p>
                                <p class="text-2xl font-semibold">${stats.avg_health_score}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-50 rounded flex items-center justify-center">
                                <i class="fas fa-shield-alt text-indigo-600"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">UEBA Alerts</p>
                                <p class="text-2xl font-semibold">${stats.ueba_alerts}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadVehicles() {
            try {
                const response = await fetch('/api/vehicles');
                const data = await response.json();
                
                const select = document.getElementById('vehicle-select');
                select.innerHTML = '<option value="">Select Vehicle</option>';
                
                data.vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.id} - ${vehicle.model}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        async function loadVehicleData() {
            const vehicleId = document.getElementById('vehicle-select').value;
            if (!vehicleId) return;
            
            try {
                const response = await fetch(`/api/vehicle/${vehicleId}`);
                const data = await response.json();
                currentVehicle = data;
                updateVehicleDisplay(data);
            } catch (error) {
                console.error('Error loading vehicle data:', error);
            }
        }

        function updateVehicleDisplay(data) {
            const vehicle = data.vehicle;
            const analysis = data.analysis;
            const telematics = data.telematics;
            
            // Vehicle details
            document.getElementById('vehicle-details').innerHTML = `
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs text-gray-600">ID</p>
                        <p class="text-sm font-medium">${vehicle.id}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs text-gray-600">Model</p>
                        <p class="text-sm font-medium">${vehicle.model}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs text-gray-600">Location</p>
                        <p class="text-sm font-medium">${vehicle.city}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs text-gray-600">Mileage</p>
                        <p class="text-sm font-medium">${vehicle.mileage.toLocaleString()} km</p>
                    </div>
                </div>
            `;
            
            // Telematics
            const telematicsGrid = document.getElementById('telematics-grid');
            const telemetryCards = [
                { key: 'engine_temp', label: 'Engine', unit: 'Â°C', icon: 'fa-temperature-high' },
                { key: 'oil_pressure', label: 'Oil', unit: 'PSI', icon: 'fa-oil-can' },
                { key: 'brake_pad_wear', label: 'Brakes', unit: '%', icon: 'fa-brake-warning' },
                { key: 'battery_voltage', label: 'Battery', unit: 'V', icon: 'fa-bolt' },
            ];
            
            telematicsGrid.innerHTML = telemetryCards.map(card => {
                const value = telematics[card.key];
                let isWarning = false;
                if (card.key === 'engine_temp' && value > 105) isWarning = true;
                if (card.key === 'brake_pad_wear' && value > 80) isWarning = true;
                if (card.key === 'oil_pressure' && value < 30) isWarning = true;
                
                return `
                    <div class="bg-gray-50 p-3 rounded text-center">
                        <i class="fas ${card.icon} text-blue-600 mb-1"></i>
                        <p class="text-xs text-gray-600">${card.label}</p>
                        <p class="text-lg font-semibold">${value.toFixed(1)}</p>
                        <span class="text-xs ${isWarning ? 'text-red-600' : 'text-green-600'}">${card.unit}</span>
                    </div>
                `;
            }).join('');
            
            // Health score
            const healthScore = analysis.health_score;
            let healthColor = healthScore >= 80 ? 'green' : healthScore >= 60 ? 'yellow' : healthScore >= 40 ? 'orange' : 'red';
            
            document.getElementById('health-score-container').innerHTML = `
                <div class="bg-${healthColor}-50 border border-${healthColor}-200 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-${healthColor}-900">Health Score</span>
                        <span class="text-2xl font-bold text-${healthColor}-900">${healthScore.toFixed(1)}</span>
                    </div>
                    <div class="w-full bg-${healthColor}-200 rounded-full h-2">
                        <div class="bg-${healthColor}-600 h-2 rounded-full" style="width: ${healthScore}%"></div>
                    </div>
                    ${analysis.anomaly_count > 0 ? `
                        <div class="mt-3 flex flex-wrap gap-1">
                            ${analysis.anomalies.map(a => `
                                <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded">
                                    ${a.sensor.replace('_', ' ')}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            updatePredictions(data.diagnosis);
            updateRCAInsights(data.rca_insights);
            updateUEBA(data.ueba);
        }

        function updatePredictions(diagnosis) {
            const container = document.getElementById('predictions-container');
            
            if (diagnosis.total === 0) {
                container.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                        <i class="fas fa-check-circle text-2xl text-green-600 mb-2"></i>
                        <p class="text-sm text-green-700 font-medium">No failure predictions</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3 flex justify-between items-center">
                    <div>
                        <p class="text-sm font-semibold text-red-900">${diagnosis.priority} Priority</p>
                        <p class="text-xs text-red-700">${diagnosis.total} predicted failures</p>
                    </div>
                    <button onclick="scheduleService()" class="text-xs bg-white text-gray-700 px-3 py-1 rounded border border-gray-300 hover:bg-gray-50">
                        Schedule Service
                    </button>
                </div>
                ${diagnosis.predictions.map(p => `
                    <div class="border border-gray-200 rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium">${p.component}</p>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">${p.severity}</span>
                                    <span class="text-xs text-gray-600">${p.probability}%</span>
                                    <span class="text-xs text-gray-600">${p.days_to_failure}d</span>
                                </div>
                            </div>
                            <p class="text-sm font-semibold">${p.cost}</p>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function updateRCAInsights(insights) {
            const container = document.getElementById('rca-container');
            container.innerHTML = insights.map(i => `
                <div class="border border-gray-200 rounded-lg p-3 mb-2">
                    <p class="text-sm font-medium mb-2">${i.pattern}</p>
                    <div class="text-xs text-gray-600 space-y-1 mb-2">
                        <p><span class="font-medium">Root Cause:</span> ${i.root_cause}</p>
                        <p><span class="font-medium">Action:</span> ${i.action}</p>
                    </div>
                    <button onclick="sendToManufacturing(${i.id})" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                        Send to Manufacturing
                    </button>
                </div>
            `).join('') || '<p class="text-sm text-gray-500 text-center py-4">No insights available</p>';
        }

        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                document.getElementById('agents-container').innerHTML = data.agents.map(agent => `
                    <div class="border border-gray-200 rounded p-3 flex items-center gap-3">
                        <span class="text-lg">${agent.icon}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${agent.name}</p>
                            <p class="text-xs text-gray-600 truncate">${agent.task}</p>
                        </div>
                        <span class="status-dot ${agent.status === 'active' ? 'bg-green-500' : 'bg-gray-400'}"></span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading agents:', error);
            }
        }

        async function loadServiceDemand() {
            try {
                const response = await fetch('/api/service-demand');
                const data = await response.json();
                
                const ctx = document.getElementById('demand-chart').getContext('2d');
                if (demandChart) demandChart.destroy();
                
                demandChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.days,
                        datasets: [{
                            label: 'Demand',
                            data: data.demand,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { drawBorder: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading service demand:', error);
            }
        }

        function updateUEBA(ueba) {
            const container = document.getElementById('ueba-container');
            const colors = { SAFE: 'green', WARNING: 'yellow', CRITICAL: 'red' };
            const color = colors[ueba.status] || 'gray';
            
            container.innerHTML = `
                <div class="bg-${color}-50 border border-${color}-200 rounded-lg p-4 mb-3">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-shield-alt text-${color}-600"></i>
                        <div>
                            <p class="text-sm font-semibold text-${color}-900">${ueba.status}</p>
                            <p class="text-xs text-${color}-700">${ueba.agents_monitored} agents monitored</p>
                        </div>
                    </div>
                </div>
                ${ueba.alerts && ueba.alerts.length > 0 ? ueba.alerts.map(alert => `
                    <div class="bg-red-50 border border-red-200 rounded p-3 mb-2">
                        <p class="text-xs font-medium text-red-900">${alert.type}</p>
                        <p class="text-xs text-red-700">${alert.message}</p>
                    </div>
                `).join('') : `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-green-600 text-xl mb-1"></i>
                        <p class="text-xs text-gray-600">No security alerts</p>
                    </div>
                `}
            `;
        }

        // Demo Functions
        async function simulateCriticalIssue() {
            if (!currentVehicle) return alert('Please select a vehicle first');
            
            try {
                const response = await fetch(`/api/vehicle/${currentVehicle.vehicle.id}/simulate-issue`, { method: 'POST' });
                const result = await response.json();
                alert(`ðŸš¨ ${result.message}\nIssues: ${result.issues.join(', ')}`);
                loadVehicleData();
                loadDashboardStats();
            } catch (error) {
                console.error('Error simulating issue:', error);
            }
        }

        async function runOrchestrationDemo() {
            if (!currentVehicle) return alert('Please select a vehicle first');
            
            alert('ðŸŽ¯ Starting Master Agent Orchestration...\n\n' +
                  '1. ðŸ“¡ Collecting telematics data\n' +
                  '2. ðŸ” Analyzing anomalies\n' +
                  '3. âš¡ Predicting failures\n' +
                  '4. ðŸ“ž Contacting customer\n' +
                  '5. ðŸ“… Scheduling service\n' +
                  '6. ðŸ”¬ Sending RCA to manufacturing\n\n' +
                  'Workflow completed!');
            
            setTimeout(() => {
                alert('ðŸ“… Service Scheduled\n\n' +
                      'Vehicle: ' + currentVehicle.vehicle.id + '\n' +
                      'Date: Tomorrow 10:00 AM\n' +
                      'Cost: â‚¹15,000');
            }, 1000);
        }

        function showRCAInsights() {
            alert('ðŸ”¬ RCA Insights Generated\n\n' +
                  'Pattern: High brake wear in urban vehicles\n' +
                  'Root Cause: Stop-and-go traffic\n' +
                  'Action: Premium brake materials\n' +
                  'Impact: 40% reduction\n\n' +
                  'âœ… Sent to manufacturing');
        }

        function sendToManufacturing(id) {
            alert(`ðŸ“¤ Insight #${id} sent to manufacturing team`);
        }

        function scheduleService() {
            if (!currentVehicle) return alert('Please select a vehicle first');
            alert('ðŸ“… Service Appointment Booked\n\n' +
                  'Vehicle: ' + currentVehicle.vehicle.id + '\n' +
                  'Date: Tomorrow 10:00 AM\n' +
                  'Priority: ' + (currentVehicle.diagnosis?.priority || 'MEDIUM'));
        }

        function refreshDashboard() {
            loadDashboardStats();
            loadServiceDemand();
            if (currentVehicle) loadVehicleData();
            loadAgents();
            
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-gray-900 text-white text-sm px-4 py-2 rounded shadow-lg';
            notification.textContent = 'Dashboard refreshed';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }
    </script>
</body>
</html>